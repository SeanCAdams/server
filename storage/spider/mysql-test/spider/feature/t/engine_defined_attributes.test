--echo #
--echo # MDEV-27106 Spider: specify connection to data node by engine-defined attributes
--echo #

--disable_query_log
--disable_result_log
--source ../t/test_init.inc
--enable_result_log
--enable_query_log

--connection master_1
CREATE DATABASE auto_test_local;
USE auto_test_local;

--connection child2_1
CREATE DATABASE auto_test_remote;
USE auto_test_remote;
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $CHILD2_1_ENGINE $CHILD2_1_CHARSET;

--connection child2_2
CREATE DATABASE auto_test_remote2;
USE auto_test_remote2;
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $CHILD2_1_ENGINE $CHILD2_1_CHARSET;

--echo # Single data node
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a";

INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");
SELECT * FROM tbl_a;

DELETE FROM tbl_a;
DROP TABLE tbl_a;

--echo # Multiple data nodes with high availability setting
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1 s_2_2" REMOTE_TABLE="tbl_a";

INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");
SELECT * FROM tbl_a;

--connection child2_1
SELECT * FROM tbl_a;

--connection child2_2
SELECT * FROM tbl_a;

--connection master_1
DELETE FROM tbl_a;
DROP TABLE tbl_a;

--echo # read only
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a" READ_ONLY=1;

--error 12518
INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");
SELECT * FROM tbl_a;

DROP TABLE tbl_a;

--echo # Multiple data nodes with partition options
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
PARTITION BY RANGE (a) (
    PARTITION p1 VALUES LESS THAN (3) REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a",
    PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_SERVER="s_2_2" REMOTE_TABLE="tbl_a"
);

INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");
SELECT * FROM tbl_a;

DELETE FROM tbl_a;
DROP TABLE tbl_a;

# invalid option value
--connection master_1
--error 12528
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a" READ_ONLY=maybe;

--echo # Multiple data nodes with table options + partition options
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a"
PARTITION BY RANGE (a) (
    PARTITION p1 VALUES LESS THAN (3),
    PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_SERVER="s_2_2"
);

INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");
SELECT * FROM tbl_a;

--connection child2_1
SELECT * FROM tbl_a;

--connection master_1
DELETE FROM tbl_a;
DROP TABLE tbl_a;

--echo # COMMENT + engine-defined option, COMMENT ignored, invalid (missing table name)
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
COMMENT='tbl "tbl_a"'
PARTITION BY RANGE (a) (
    PARTITION p1 VALUES LESS THAN (3) COMMENT='srv "s_2_1"',
    PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_SERVER="s_2_2"
);

--error 12702
INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");

--connection master_1
# FIXME: the following delete statement, if uncommented, causes an
# assertion failure
# DELETE FROM tbl_a;
DROP TABLE tbl_a;

--echo # COMMENT + engine-defined option, COMMENT ignored, ok
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a"
PARTITION BY RANGE (a) (
    PARTITION p1 VALUES LESS THAN (3) COMMENT='srv "s_2_2"',
    PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_SERVER="s_2_2"
);

INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb"), (3, "ccc"), (4, "ddd");

--connection child2_1
SELECT * FROM tbl_a;

--connection child2_2
SELECT * FROM tbl_a;

--connection master_1
DELETE FROM tbl_a;
DROP TABLE tbl_a;

--echo # COMMENT + engine-defined option, COMMENT ignored, ok
--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" REMOTE_TABLE="tbl_a" READ_ONLY=YES
PARTITION BY RANGE (a) (
    PARTITION p1 VALUES LESS THAN (3) COMMENT='srv "s_2_2" read_only_mode "0"',
    PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_SERVER="s_2_2" READ_ONLY=NO
);

--error 12518
INSERT INTO tbl_a VALUES (1, "aaa"), (2, "bbb");
INSERT INTO tbl_a VALUES (3, "ccc"), (4, "ddd");

--connection child2_1
SELECT * FROM tbl_a;

--connection child2_2
SELECT * FROM tbl_a;
DELETE FROM tbl_a;

--connection master_1
# FIXME: the following delete statement, if uncommented, causes an
# assertion failure
#DELETE FROM tbl_a;
DROP TABLE tbl_a;

--connection master_1
eval CREATE TABLE tbl_a (
  a INT,
  b VARCHAR(255),
  PRIMARY KEY(a)
) $MASTER_1_ENGINE $MASTER_1_CHARSET
REMOTE_SERVER="s_2_1" COMMENT='tbl "tbl_b"' REMOTE_TABLE="tbl_a";

select table_name, server, tgt_table_name from mysql.spider_tables;
drop table tbl_a;

eval CREATE TABLE tbl_a (
  a INT
) $MASTER_1_ENGINE $MASTER_1_CHARSET
PARTITION BY HASH (a) PARTITIONS 2;
--error ER_CONNECT_TO_FOREIGN_DATA_SOURCE
SELECT * FROM tbl_a;
DROP TABLE tbl_a;

--echo # MDEV-27860 SIGSEGV in spider_parse_connect_info on CREATE TABLE
--error ER_FOREIGN_SERVER_DOESNT_EXIST
CREATE TABLE tbl_a ENGINE=SPIDER COMMENT="TABLE 'unknown_table'"
PARTITION BY LIST COLUMNS (c) (
  PARTITION p DEFAULT COMMENT="srv 'unknown_server'" ENGINE=SPIDER
);

--connection child2_1
DROP DATABASE auto_test_remote;

--connection child2_2
DROP DATABASE auto_test_remote2;

--connection master_1
DROP DATABASE auto_test_local;

--disable_query_log
--disable_result_log
--source ../t/test_deinit.inc
--enable_result_log
--enable_query_log
